name: 02 Search Phrase

on:
  workflow_run:
    workflows: ["01 Download Sitemaps"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      search_phrase:
        description: 'Phrase to search for (overrides default)'
        required: true
        default: 'Black Friday Sale'

env:
  SITEMAP_REPO: your-username/sitemaps-data
  RESULTS_REPO: your-username/search-results

jobs:
  search:
    runs-on: ubuntu-latest
    # Run if triggered by workflow completion (success) OR manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout Tool Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Checkout Sitemaps Data
        uses: actions/checkout@v3
        with:
          repository: ${{ env.SITEMAP_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: sitemaps_archive
          # Checked out to 'sitemaps_archive' so searcher.py finds it

      - name: Run Searcher
        env:
          SEARCH_PHRASE: ${{ github.event.inputs.search_phrase || 'Black Friday Sale' }}
        run: python scripts/searcher.py

      - name: Checkout Results Storage
        uses: actions/checkout@v3
        with:
          repository: ${{ env.RESULTS_REPO }}
          token: ${{ secrets.GH_PAT }}
          path: results_repo

      - name: Push Results to External Repo
        run: |
          echo "Syncing results to results repo..."
          cp results_*.txt results_repo/
          
          cd results_repo
          git config user.name "Sitemap Hunter Bot"
          git config user.email "bot@actionforge.local"
          
          git add .
          
          TODAY=$(date +'%Y-%m-%d')
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Search results for $TODAY"
            git push
          fi
