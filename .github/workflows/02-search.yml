name: 02 Search Phrase (mangas)

on:
  workflow_run:
    workflows: ["01 Download Sitemaps (mangas)"]
    types: [completed]
  workflow_dispatch:
    inputs:
      search_phrase:
        description: 'Frase o tÃ©rmino a buscar en los sitemaps'
        required: true
        default: 'Dragon Ball'
      target_branch:
        description: 'Rama de origen de los sitemaps'
        required: true
        type: choice
        default: 'mangas-sitemaps'
        options:
          - 'mangas-sitemaps'
          - 'main'
      custom_branch:
        description: 'Rama personalizada (si no estÃ¡ en la lista)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  search:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: ðŸ§¹ Massive Disk Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          df -h

      - name: ðŸ› ï¸ Performance Git Tuning
        run: |
          git config --global http.postBuffer 1048576000
          git config --global user.name "Searcher Bot"
          git config --global user.email "search@actionforge.local"

      - name: ðŸ“¥ Checkout Main Engine
        uses: actions/checkout@v3
        with:
          path: main_code

      - name: ðŸ—‚ï¸ Clone Sitemap Data
        run: |
          BRANCH_NAME="${{ github.event.inputs.custom_branch || github.event.inputs.target_branch || 'mangas-sitemaps' }}"
          echo "Targeting branch: $BRANCH_NAME"
          git clone --depth 1 --branch "$BRANCH_NAME" "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" sitemaps_data
          # Remove .git from data to avoid nested repo issues
          rm -rf sitemaps_data/.git

      - name: ðŸ“‘ Prepare Results Repository
        run: |
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          if git ls-remote --heads "$REPO_URL" "mangas-results" | grep -q "mangas-results"; then
            git clone --depth 1 --branch mangas-results "$REPO_URL" results_repo
            # Import previous search state to avoid full rescans
            cp results_repo/search_state.json sitemaps_data/ 2>/dev/null || true
          else
            mkdir results_repo && cd results_repo
            git init && git checkout -b mangas-results
            git remote add origin "$REPO_URL"
            cd ..
          fi

      - name: ðŸš€ Run Searcher Engine
        env:
          SEARCH_PHRASE: ${{ github.event.inputs.search_phrase || 'Dragon Ball' }}
        run: python main_code/scripts/searcher.py --phrase "$SEARCH_PHRASE"

      - name: ðŸ“¤ Deploy Results to Results Branch
        run: |
          # Copy findings and updated state
          cp hits_* sitemaps_data/search_state.json report_* results_repo/ 2>/dev/null || true
          cd results_repo
          git remote add origin_auth "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" || true
          git add .
          if ! git diff --staged --quiet; then
            PHRASE_TAG="${{ github.event.inputs.search_phrase || 'Dragon Ball' }}"
            git commit -m "New findings for: $PHRASE_TAG ($(date +'%Y-%m-%d'))"
            git push origin_auth mangas-results
          else
            echo "No new findings detected."
          fi
