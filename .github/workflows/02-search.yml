name: 02 Search Phrase

on:
  workflow_run:
    workflows: ["01 Download Sitemaps"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      search_phrase:
        description: 'Phrase to search for (overrides default)'
        required: true
        default: 'Black Friday Sale'

permissions:
  contents: write

env:
  SITEMAP_BRANCH: data-sitemaps
  RESULTS_BRANCH: data-results

jobs:
  search:
    runs-on: ubuntu-latest
    # Run if triggered by workflow completion (success) OR manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout Tool Code (Main Branch)
        uses: actions/checkout@v3
        with:
          path: main_code

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Checkout Data from Sitemap Branch
        uses: actions/checkout@v3
        with:
          ref: ${{ env.SITEMAP_BRANCH }}
          path: main_code/sitemaps_archive
          # We mount the data into the script's expected folder

      - name: Run Searcher
        working-directory: main_code
        env:
          SEARCH_PHRASE: ${{ github.event.inputs.search_phrase || 'Black Friday Sale' }}
        run: python scripts/searcher.py

      - name: Deploy to Results Branch
        run: |
          # 1. Configure Git
          git config --global user.name "Sitemap Hunter Bot"
          git config --global user.email "bot@actionforge.local"
          
          # 2. Save Results
          mkdir results_temp
          cp main_code/results_*.txt results_temp/
          
          # 3. Switch to Results Branch
          git fetch origin ${{ env.RESULTS_BRANCH }} || echo "Branch does not exist yet."
          
          if git show-ref --verify --quiet refs/remotes/origin/${{ env.RESULTS_BRANCH }}; then
             # Use a fresh checkout of the results branch to avoid conflicts
             git checkout ${{ env.RESULTS_BRANCH }}
          else
             git checkout --orphan ${{ env.RESULTS_BRANCH }}
             git rm -rf .
          fi
          
          # 4. Copy results and Push
          cp -r results_temp/* .
          rm -rf results_temp main_code
          
          git add .
          
          TODAY=$(date +'%Y-%m-%d')
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Search results for $TODAY"
            git push origin ${{ env.RESULTS_BRANCH }}
          fi
