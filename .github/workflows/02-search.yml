name: 02 Search Phrase

on:
  workflow_run:
    workflows: ["01 Download Sitemaps (Incremental)"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      search_phrase:
        description: 'Phrase to search for'
        required: true
        default: 'Black Friday Sale'

permissions:
  contents: write

env:
  SITEMAP_BRANCH: data-sitemaps
  RESULTS_BRANCH: data-results

jobs:
  search:
    runs-on: ubuntu-latest
    # Only run on successful download or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout Tool Code
        uses: actions/checkout@v3
        with:
          path: main_code

      - name: Checkout Data
        run: |
           REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
           
           # Check if sitemap branch exists
           if git ls-remote --heads "$REPO_URL" "${{ env.SITEMAP_BRANCH }}" | grep -q "${{ env.SITEMAP_BRANCH }}"; then
             git clone --single-branch --branch ${{ env.SITEMAP_BRANCH }} "$REPO_URL" sitemaps_data
           else
             echo "Sitemap branch not found. Skipping search."
             exit 0
           fi
      
      - name: Run Searcher
        env:
          SEARCH_PHRASE: ${{ github.event.inputs.search_phrase || 'Black Friday Sale' }}
        run: |
          if [ ! -d "sitemaps_data" ]; then
            echo "Data folder missing."
            exit 0
          fi
          python main_code/scripts/searcher.py

      - name: Deploy Results
        run: |
          git config --global user.name "Sitemap Bot"
          git config --global user.email "bot@actionforge.local"
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          
          # Move results to temp
          mkdir -p results_temp
          cp results_*.txt results_temp/ 2>/dev/null || echo "No results generated."
          
          # Prepare Results Branch
          if git ls-remote --heads "$REPO_URL" "${{ env.RESULTS_BRANCH }}" | grep -q "${{ env.RESULTS_BRANCH }}"; then
             echo "Cloning results branch..."
             git clone --single-branch --branch ${{ env.RESULTS_BRANCH }} "$REPO_URL" results_repo
          else
             echo "Initializing results branch..."
             mkdir results_repo && cd results_repo
             git init
             git checkout -b ${{ env.RESULTS_BRANCH }}
             # Create dummy file for initial commit
             echo "Results Storage" > README.md
             git add .
             git commit -m "Init results"
             cd ..
          fi
          
          # Copy results
          cd results_repo
          cp ../results_temp/* . 2>/dev/null || echo "No new files to copy."
          git add .
          
          TODAY=$(date +'%Y-%m-%d')
          if git diff --staged --quiet; then
             echo "No results changed."
          else
             echo "Pushing results..."
             git commit -m "Search results: $TODAY"
             
             # FORCE SET REMOTE
             git remote remove origin || true
             git remote add origin "$REPO_URL"
             
             git push origin ${{ env.RESULTS_BRANCH }}
          fi
