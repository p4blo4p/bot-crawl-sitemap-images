name: 02 Search Phrase

on:
  workflow_run:
    workflows: ["01 Download Sitemaps (Incremental)"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      search_phrase:
        description: 'Phrase to search for'
        required: true
        default: 'Black Friday Sale'

permissions:
  contents: write

env:
  SITEMAP_BRANCH: data-sitemaps
  RESULTS_BRANCH: data-results

jobs:
  search:
    runs-on: ubuntu-latest
    # Only run on successful download or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout Tool Code
        uses: actions/checkout@v3
        with:
          path: main_code

      - name: Checkout Data
        uses: actions/checkout@v3
        with:
          ref: ${{ env.SITEMAP_BRANCH }}
          path: sitemaps_data
      
      - name: Run Searcher
        env:
          SEARCH_PHRASE: ${{ github.event.inputs.search_phrase || 'Black Friday Sale' }}
        run: |
          # Script expects 'sitemaps_data' in current dir
          # We add a check to ensure data exists, otherwise skip gracefully
          if [ ! -d "sitemaps_data" ]; then
            echo "Data folder not found. Skipping search."
            exit 0
          fi
          python main_code/scripts/searcher.py

      - name: Deploy Results
        run: |
          git config --global user.name "Sitemap Bot"
          git config --global user.email "bot@actionforge.local"
          
          # Move results to temp
          mkdir -p results_temp
          cp results_*.txt results_temp/ 2>/dev/null || echo "No results generated."
          
          # Clone/Init Results Branch
          echo "Setting up results branch..."
          git fetch origin ${{ env.RESULTS_BRANCH }} || echo "Remote branch not found"
          
          if git rev-parse --verify origin/${{ env.RESULTS_BRANCH }} >/dev/null 2>&1; then
             git clone --single-branch --branch ${{ env.RESULTS_BRANCH }} https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git results_repo
          else
             mkdir results_repo && cd results_repo
             git init
             git checkout -b ${{ env.RESULTS_BRANCH }}
             cd ..
          fi
          
          # Copy results
          cd results_repo
          cp ../results_temp/* . 2>/dev/null || echo "No new files to copy."
          git add .
          
          TODAY=$(date +'%Y-%m-%d')
          if git diff --staged --quiet; then
             echo "No results changed."
          else
             git commit -m "Search results: $TODAY"
             git push origin ${{ env.RESULTS_BRANCH }}
          fi
