name: 01 Download Sitemaps (Incremental)

on:
  schedule:
    - cron: '0 8 * * 1'
  workflow_dispatch:

permissions:
  contents: write

env:
  SITEMAP_BRANCH: data-sitemaps

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 60 
    steps:
      - name: Checkout Tool Code
        uses: actions/checkout@v3
        with:
          path: main_code

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Prepare Data Branch
        run: |
          # Set up Git User
          git config --global user.name "Sitemap Bot"
          git config --global user.email "bot@actionforge.local"
          
          # Remote URL with Token
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          
          echo "Checking for remote branch ${{ env.SITEMAP_BRANCH }}..."
          
          # Use ls-remote to check existence without needing a local repo context
          if git ls-remote --heads "$REPO_URL" "${{ env.SITEMAP_BRANCH }}" | grep -q "${{ env.SITEMAP_BRANCH }}"; then
            echo "Branch exists. Cloning..."
            git clone --single-branch --branch ${{ env.SITEMAP_BRANCH }} "$REPO_URL" sitemaps_data
          else
            echo "Branch not found. Initializing new data folder..."
            mkdir sitemaps_data
            cd sitemaps_data
            git init
            git checkout -b ${{ env.SITEMAP_BRANCH }}
            
            # Create an initial file so we can commit
            echo '{"created": true}' > state.json
            git add .
            git commit -m "Initial data structure"
            # We don't push here, we wait for the script to run
            cd ..
          fi

      - name: Run Incremental Downloader
        run: |
          # Copy sites.txt to root so script finds it
          cp main_code/sites.txt .
          # Run script from main_code, but it writes to sitemaps_data
          python main_code/scripts/downloader.py

      - name: Commit and Push Changes
        working-directory: sitemaps_data
        run: |
          git add .
          
          TODAY=$(date +'%Y-%m-%d')
          if git diff --staged --quiet; then
            echo "No changes detected. Everything is up to date."
          else
            echo "Changes detected. Pushing update..."
            git commit -m "Update sitemaps (Checkpoint): $TODAY"
            
            # FORCE SET REMOTE to ensure push works even if clone/init was quirky
            git remote remove origin || true
            git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            
            git push origin ${{ env.SITEMAP_BRANCH }}
          fi
