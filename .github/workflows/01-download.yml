name: 01 Download Sitemaps (Incremental)

on:
  schedule:
    - cron: '0 8 * * 1'
  workflow_dispatch:

permissions:
  contents: write

env:
  SITEMAP_BRANCH: data-sitemaps

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Tool Code
        uses: actions/checkout@v3
        with:
          path: main_code

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Prepare Data Branch
        run: |
          # We clone the data branch into 'sitemap_data' folder
          # The script is configured to read/write to this folder
          
          git config --global user.name "Sitemap Bot"
          git config --global user.email "bot@actionforge.local"
          
          echo "Checking for existing data branch..."
          git fetch origin ${{ env.SITEMAP_BRANCH }} || echo "Branch not found."
          
          if git rev-parse --verify origin/${{ env.SITEMAP_BRANCH }} >/dev/null 2>&1; then
            echo "Branch exists. cloning..."
            # Clone single branch into subfolder
            git clone --single-branch --branch ${{ env.SITEMAP_BRANCH }} https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git sitemaps_data
          else
            echo "First run. Creating empty data folder."
            mkdir sitemaps_data
            cd sitemaps_data
            git init
            git checkout -b ${{ env.SITEMAP_BRANCH }}
            # Need an initial commit to push
            echo "{" > state.json
            echo "}" >> state.json
            git add .
            git commit -m "Initial data commit"
            # We don't push yet, we wait for script
            cd ..
          fi

      - name: Run Incremental Downloader
        run: |
          # Copy sites.txt to root so script finds it
          cp main_code/sites.txt .
          # Run script from main_code, but it writes to sitemaps_data
          python main_code/scripts/downloader.py

      - name: Commit and Push Changes
        working-directory: sitemaps_data
        run: |
          git add .
          
          TODAY=$(date +'%Y-%m-%d')
          if git diff --staged --quiet; then
            echo "No changes detected. Everything is up to date."
          else
            echo "Changes detected. Pushing update..."
            git commit -m "Update sitemaps: $TODAY"
            git push origin ${{ env.SITEMAP_BRANCH }}
          fi
