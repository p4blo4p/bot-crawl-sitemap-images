name: 01 Download Sitemaps (mangas)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

# Prevent race conditions if runs stack up
concurrency:
  group: sitemap-download-mangas
  cancel-in-progress: false

env:
  SITEMAP_BRANCH: ${{ github.event.inputs.list_name || 'mangas-sitemaps' }}

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Allow up to 6 hours
    steps:
      - name: Free Disk Space (Aggressive)
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Checkout Tool Code
        uses: actions/checkout@v3
        with:
          path: main_code

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Prepare Data Branch
        run: |
          git config --global user.name "Sitemap Bot"
          git config --global user.email "bot@actionforge.local"
          # Optimizar Git para repos grandes
          git config --global http.postBuffer 1048576000
          git config --global http.version HTTP/1.1
          git config --global core.compression 9
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global pack.windowMemory 100m
          
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          
          if git ls-remote --heads "$REPO_URL" "${{ env.SITEMAP_BRANCH }}" | grep -q "${{ env.SITEMAP_BRANCH }}"; then
            echo "Branch exists. Cloning..."
            git clone --depth 1 --single-branch --branch ${{ env.SITEMAP_BRANCH }} "$REPO_URL" sitemaps_data
          else
            echo "Branch not found. Initializing..."
            mkdir sitemaps_data && cd sitemaps_data
            git init
            git checkout -b ${{ env.SITEMAP_BRANCH }}
            git remote add origin "$REPO_URL"
            echo '{"init": true}' > global_state.json
            git add . && git commit -m "Initialize data structure"
            cd ..
          fi

      - name: Run Downloader
        env:
          SITES_FILE: main_code/sites/mangas.txt
        run: |
          python main_code/scripts/downloader.py

      - name: Push Changes
        working-directory: sitemaps_data
        run: |
          git add .
          TODAY=$(date +'%Y-%m-%d')
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "Update sitemaps and stats (mangas): $TODAY"
            git push origin ${{ env.SITEMAP_BRANCH }}
          fi
